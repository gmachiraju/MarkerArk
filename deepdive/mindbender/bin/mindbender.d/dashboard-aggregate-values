#!/usr/bin/env node
(function() {
  var fs, lastSnapshotIndex, mtime, name, report, reportValues, reportValuesBySnapshot, snapshot, snapshotIndex, snapshotNames, snapshots, snapshotsUnordered, value, valueArray, valueArrayByName, valueByName, _, _i, _len, _ref, _ref1,
    __slice = [].slice;

  fs = require("fs");

  _ = require("underscore");

  _ref = process.argv.slice(2), snapshotNames = 1 <= _ref.length ? __slice.call(_ref, 0) : [];

  reportValuesBySnapshot = {};

  snapshotsUnordered = (function() {
    var _i, _len, _ref1, _results;
    _results = [];
    for (snapshotIndex = _i = 0, _len = snapshotNames.length; _i < _len; snapshotIndex = ++_i) {
      snapshot = snapshotNames[snapshotIndex];
      reportValuesBySnapshot[snapshot] = (_ref1 = ((function() {
        try {
          return JSON.parse(fs.readFileSync("snapshot/" + snapshot + "/reports.json"));
        } catch (_error) {}
      })())) != null ? _ref1 : {};
      mtime = fs.statSync("snapshot/" + snapshot + "/reports.ids").mtime;
      _results.push({
        name: snapshot,
        time: mtime
      });
    }
    return _results;
  })();

  snapshots = _.sortBy(snapshotsUnordered, function(_arg) {
    var time;
    time = _arg.time;
    return time;
  });

  reportValues = {};

  for (snapshotIndex = _i = 0, _len = snapshots.length; _i < _len; snapshotIndex = ++_i) {
    snapshot = snapshots[snapshotIndex].name;
    _ref1 = reportValuesBySnapshot[snapshot];
    for (report in _ref1) {
      valueByName = _ref1[report].values;
      if (!((_.size(valueByName)) > 0)) {
        continue;
      }
      valueArrayByName = (reportValues[report] != null ? reportValues[report] : reportValues[report] = {});
      for (name in valueByName) {
        value = valueByName[name];
        valueArray = (valueArrayByName[name] != null ? valueArrayByName[name] : valueArrayByName[name] = []);
        valueArray[snapshotIndex] = value;
      }
    }
  }

  lastSnapshotIndex = (_.size(snapshots)) - 1;

  for (report in reportValues) {
    valueArrayByName = reportValues[report];
    for (name in valueArrayByName) {
      valueArray = valueArrayByName[name];
      if (valueArray[lastSnapshotIndex] == null) {
        valueArray[lastSnapshotIndex] = null;
      }
    }
  }

  console.log(JSON.stringify({
    snapshots: snapshots,
    reportValues: reportValues
  }));

}).call(this);
